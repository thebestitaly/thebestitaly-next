<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget TheBestItaly - Dinamico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }
        
        .font-script {
            font-family: 'Georgia', serif;
            font-style: italic;
        }
        
        .dropdown-enter {
            opacity: 0;
            transform: translateY(-10px);
        }
        
        .dropdown-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.2s ease-out;
        }
        
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100">
    <!-- Configuratore -->
    <!-- Hero Section -->
    <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-cyan-600 text-white">
        <div class="max-w-6xl mx-auto px-4 py-12 text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">
                ğŸ‡®ğŸ‡¹ Widget <span class="font-script">theBest</span> Italy
            </h1>
            <p class="text-xl opacity-90 mb-8">Integra le eccellenze italiane nel tuo sito web</p>
            
            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-3xl mx-auto">
                <div class="bg-white/10 backdrop-blur rounded-lg p-4">
                    <div class="text-2xl font-bold">40+</div>
                    <div class="text-sm opacity-80">Lingue</div>
                </div>
                <div class="bg-white/10 backdrop-blur rounded-lg p-4">
                    <div class="text-2xl font-bold">10k+</div>
                    <div class="text-sm opacity-80">Aziende</div>
                </div>
                <div class="bg-white/10 backdrop-blur rounded-lg p-4">
                    <div class="text-2xl font-bold">SEO</div>
                    <div class="text-sm opacity-80">Ottimizzato</div>
                </div>
                <div class="bg-white/10 backdrop-blur rounded-lg p-4">
                    <div class="text-2xl font-bold">Real</div>
                    <div class="text-sm opacity-80">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto mb-8 mt-8 px-4">
        
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- Widget Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo Widget</label>
                    <select id="widgetType" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-300">
                        <option value="small">Small</option>
                        <option value="medium" selected>Medium</option>
                        <option value="full">Full</option>
                    </select>
                </div>

                <!-- Content Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo Contenuto</label>
                    <select id="contentType" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-300">
                        <option value="articolo">Articolo</option>
                        <option value="destinazione">Destinazione</option>
                        <option value="azienda">Azienda</option>
                    </select>
                </div>

                <!-- Search Term -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cerca</label>
                    <input type="text" id="searchTerm" placeholder="es. Ferrari, Roma..." 
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-300">
                </div>

                <!-- Search Button -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">&nbsp;</label>
                    <button id="searchBtn" class="w-full bg-cyan-300 hover:bg-cyan-400 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors">
                        ğŸ” Cerca
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Widget Preview -->
    <div class="flex justify-center mb-8 px-4">
        <div id="widgetContainer">
            <!-- Widget verrÃ  generato qui -->
        </div>
    </div>

    <!-- Results List -->
    <div id="resultsList" class="max-w-4xl mx-auto hidden px-4">
        <h3 class="text-xl font-semibold mb-4 text-gray-800">ğŸ¯ Risultati Trovati:</h3>
        <div id="resultsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Risultati verranno inseriti qui -->
        </div>
    </div>

    <script>
        // Languages database
        const languages = [
        { code: 'af', name: 'Afrikaans', nativeName: 'Afrikaans', flag: 'ğŸ‡¿ğŸ‡¦', rtl: false },
  { code: 'am', name: 'Amharic', nativeName: 'áŠ áˆ›áˆ­áŠ›', flag: 'ğŸ‡ªğŸ‡¹', rtl: false },
  { code: 'ar', name: 'Arabic', nativeName: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', flag: 'ğŸ‡¸ğŸ‡¦', rtl: true },
  { code: 'az', name: 'Azerbaijani', nativeName: 'AzÉ™rbaycan', flag: 'ğŸ‡¦ğŸ‡¿', rtl: false },
  { code: 'bg', name: 'Bulgarian', nativeName: 'Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸', flag: 'ğŸ‡§ğŸ‡¬', rtl: false },
  { code: 'bn', name: 'Bengali', nativeName: 'à¦¬à¦¾à¦‚à¦²à¦¾', flag: 'ğŸ‡§ğŸ‡©', rtl: false },
  { code: 'ca', name: 'Catalan', nativeName: 'CatalÃ ', flag: 'ğŸ‡ªğŸ‡¸', rtl: false },
  { code: 'cs', name: 'Czech', nativeName: 'ÄŒeÅ¡tina', flag: 'ğŸ‡¨ğŸ‡¿', rtl: false },
  { code: 'da', name: 'Danish', nativeName: 'Dansk', flag: 'ğŸ‡©ğŸ‡°', rtl: false },
  { code: 'de', name: 'German', nativeName: 'Deutsch', flag: 'ğŸ‡©ğŸ‡ª', rtl: false },
  { code: 'el', name: 'Greek', nativeName: 'Î•Î»Î»Î·Î½Î¹ÎºÎ¬', flag: 'ğŸ‡¬ğŸ‡·', rtl: false },
  { code: 'en', name: 'English', nativeName: 'English', flag: 'ğŸ‡¬ğŸ‡§', rtl: false },
  { code: 'es', name: 'Spanish', nativeName: 'EspaÃ±ol', flag: 'ğŸ‡ªğŸ‡¸', rtl: false },
  { code: 'et', name: 'Estonian', nativeName: 'Eesti', flag: 'ğŸ‡ªğŸ‡ª', rtl: false },
  { code: 'fa', name: 'Persian', nativeName: 'ÙØ§Ø±Ø³ÛŒ', flag: 'ğŸ‡®ğŸ‡·', rtl: true },
  { code: 'fi', name: 'Finnish', nativeName: 'Suomi', flag: 'ğŸ‡«ğŸ‡®', rtl: false },
  { code: 'fr', name: 'French', nativeName: 'FranÃ§ais', flag: 'ğŸ‡«ğŸ‡·', rtl: false },
  { code: 'he', name: 'Hebrew', nativeName: '×¢×‘×¨×™×ª', flag: 'ğŸ‡®ğŸ‡±', rtl: true },
  { code: 'hi', name: 'Hindi', nativeName: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€', flag: 'ğŸ‡®ğŸ‡³', rtl: false },
  { code: 'hr', name: 'Croatian', nativeName: 'Hrvatski', flag: 'ğŸ‡­ğŸ‡·', rtl: false },
  { code: 'hu', name: 'Hungarian', nativeName: 'Magyar', flag: 'ğŸ‡­ğŸ‡º', rtl: false },
  { code: 'hy', name: 'Armenian', nativeName: 'Õ€Õ¡ÕµÕ¥Ö€Õ¥Õ¶', flag: 'ğŸ‡¦ğŸ‡²', rtl: false },
  { code: 'id', name: 'Indonesian', nativeName: 'Bahasa Indonesia', flag: 'ğŸ‡®ğŸ‡©', rtl: false },
  { code: 'is', name: 'Icelandic', nativeName: 'Ãslenska', flag: 'ğŸ‡®ğŸ‡¸', rtl: false },
  { code: 'it', name: 'Italian', nativeName: 'Italiano', flag: 'ğŸ‡®ğŸ‡¹', rtl: false },
  { code: 'ja', name: 'Japanese', nativeName: 'æ—¥æœ¬èª', flag: 'ğŸ‡¯ğŸ‡µ', rtl: false },
  { code: 'ka', name: 'Georgian', nativeName: 'áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜', flag: 'ğŸ‡¬ğŸ‡ª', rtl: false },
  { code: 'ko', name: 'Korean', nativeName: 'í•œêµ­ì–´', flag: 'ğŸ‡°ğŸ‡·', rtl: false },
  { code: 'lt', name: 'Lithuanian', nativeName: 'LietuviÅ³', flag: 'ğŸ‡±ğŸ‡¹', rtl: false },
  { code: 'lv', name: 'Latvian', nativeName: 'LatvieÅ¡u', flag: 'ğŸ‡±ğŸ‡»', rtl: false },
  { code: 'mk', name: 'Macedonian', nativeName: 'ĞœĞ°ĞºĞµĞ´Ğ¾Ğ½ÑĞºĞ¸', flag: 'ğŸ‡²ğŸ‡°', rtl: false },
  { code: 'ms', name: 'Malay', nativeName: 'Bahasa Melayu', flag: 'ğŸ‡²ğŸ‡¾', rtl: false },
  { code: 'nl', name: 'Dutch', nativeName: 'Nederlands', flag: 'ğŸ‡³ğŸ‡±', rtl: false },
  { code: 'pl', name: 'Polish', nativeName: 'Polski', flag: 'ğŸ‡µğŸ‡±', rtl: false },
  { code: 'pt', name: 'Portuguese', nativeName: 'PortuguÃªs', flag: 'ğŸ‡µğŸ‡¹', rtl: false },
  { code: 'ro', name: 'Romanian', nativeName: 'RomÃ¢nÄƒ', flag: 'ğŸ‡·ğŸ‡´', rtl: false },
  { code: 'ru', name: 'Russian', nativeName: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹', flag: 'ğŸ‡·ğŸ‡º', rtl: false },
  { code: 'sk', name: 'Slovak', nativeName: 'SlovenÄina', flag: 'ğŸ‡¸ğŸ‡°', rtl: false },
  { code: 'sl', name: 'Slovenian', nativeName: 'SlovenÅ¡Äina', flag: 'ğŸ‡¸ğŸ‡®', rtl: false },
  { code: 'sr', name: 'Serbian', nativeName: 'Ğ¡Ñ€Ğ¿ÑĞºĞ¸', flag: 'ğŸ‡·ğŸ‡¸', rtl: false },
  { code: 'sv', name: 'Swedish', nativeName: 'Svenska', flag: 'ğŸ‡¸ğŸ‡ª', rtl: false },
  { code: 'sw', name: 'Swahili', nativeName: 'Kiswahili', flag: 'ğŸ‡¹ğŸ‡¿', rtl: false },
  { code: 'th', name: 'Thai', nativeName: 'à¹„à¸—à¸¢', flag: 'ğŸ‡¹ğŸ‡­', rtl: false },
  { code: 'tl', name: 'Filipino', nativeName: 'Filipino', flag: 'ğŸ‡µğŸ‡­', rtl: false },
  { code: 'tk', name: 'Turkish', nativeName: 'TÃ¼rkÃ§e', flag: 'ğŸ‡¹ğŸ‡·', rtl: false },
  { code: 'uk', name: 'Ukrainian', nativeName: 'Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°', flag: 'ğŸ‡ºğŸ‡¦', rtl: false },
  { code: 'ur', name: 'Urdu', nativeName: 'Ø§Ø±Ø¯Ùˆ', flag: 'ğŸ‡µğŸ‡°', rtl: true },
  { code: 'vi', name: 'Vietnamese', nativeName: 'Tiáº¿ng Viá»‡t', flag: 'ğŸ‡»ğŸ‡³', rtl: false },
  { code: 'zh', name: 'Chinese', nativeName: 'ä¸­æ–‡', flag: 'ğŸ‡¨ğŸ‡³', rtl: false },
  { code: 'zh-tw', name: 'Traditional Chinese', nativeName: 'ç¹é«”ä¸­æ–‡', flag: 'ğŸ‡¹ğŸ‡¼', rtl: false }
        ];

        // State
        let state = {
            widgetType: 'medium',
            contentType: 'azienda',
            searchTerm: '',
            selectedLanguage: 'it',
            isDropdownOpen: false,
            searchResults: [],
            selectedContent: null
        };

        // Funzione per renderizzare markdown semplice
        function renderMarkdown(text) {
            if (!text) return '';
            
            return text
                // Headings (devono essere prima dei paragrafi)
                .replace(/^### (.*$)/gm, '<h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">$1</h3>')
                .replace(/^## (.*$)/gm, '<h2 class="text-xl font-bold text-gray-900 mt-6 mb-3">$1</h2>')
                .replace(/^# (.*$)/gm, '<h1 class="text-2xl font-bold text-gray-900 mt-6 mb-4">$1</h1>')
                // Grassetto **text** o __text__
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.*?)__/g, '<strong>$1</strong>')
                // Corsivo *text* o _text_
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/_(.*?)_/g, '<em>$1</em>')
                // Link [text](url)
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">$1</a>')
                // Paragrafi (doppi a capo)
                .replace(/\n\s*\n/g, '</p><p class="mb-3">')
                // Singoli a capo
                .replace(/\n/g, '<br>')
                // Wrappa tutto in un paragrafo (ma non gli heading)
                .replace(/^(?!<h[1-6])(.*?)$/gm, '<p class="mb-3">$1</p>')
                // Pulisci paragrafi vuoti
                .replace(/<p class="mb-3"><\/p>/g, '')
                // Pulisci paragrafi che contengono solo <br>
                .replace(/<p class="mb-3"><br><\/p>/g, '');
        }

        // Get widget sizes
        function getWidgetSize(type) {
            switch (type) {
                case 'small': return 'w-80 h-auto min-h-32';
                case 'medium': return 'w-96 h-auto min-h-40';
                case 'full': return 'w-full h-auto min-h-[600px]';
                default: return 'w-96 h-auto min-h-40';
            }
        }

        function getContentSize(type) {
            switch (type) {
                case 'small': return 'text-xs';
                case 'medium': return 'text-sm';
                case 'full': return 'text-base';
                default: return 'text-sm';
            }
        }

        function getTitleSize(type) {
            switch (type) {
                case 'small': return 'text-base';
                case 'medium': return 'text-lg';
                case 'full': return 'text-2xl';
                default: return 'text-lg';
            }
        }

        function getDropdownSize(type) {
            switch (type) {
                case 'small': return 'max-h-32 text-xs';
                case 'medium': return 'max-h-40 text-sm';
                case 'full': return 'max-h-60 text-base';
                default: return 'max-h-40 text-sm';
            }
        }

        function getButtonSize(type) {
            switch (type) {
                case 'small': return 'px-2 py-1 text-xs';
                case 'medium': return 'px-3 py-2 text-sm';
                case 'full': return 'px-4 py-3 text-base';
                default: return 'px-3 py-2 text-sm';
            }
        }

                        // API Functions - RICERCA REALE DAL DATABASE
        async function searchContent(type, term, language) {
            console.log(`ğŸ” [WIDGET] Iniziando ricerca: ${type} - "${term}" in ${language}`);
            
            // Mostra loading
            showLoadingSkeleton();
            
            try {
                const requestData = { 
                    type, 
                    query: term, 
                    language,
                    limit: 5 
                };
                
                console.log(`ğŸ“¤ [WIDGET] Dati richiesta:`, requestData);
                console.log(`ğŸŒ [WIDGET] URL chiamata: /api/widget/search`);
                
                const response = await fetch('/api/widget/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                console.log(`ğŸ“¡ [WIDGET] Response status: ${response.status}`);
                console.log(`ğŸ“‹ [WIDGET] Response headers:`, Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`âŒ [WIDGET] Response error: ${response.status} - ${errorText}`);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }
                
                const results = await response.json();
                console.log(`âœ… [WIDGET] Ricevuti ${results.length} risultati dal server`);
                console.log(`ğŸ“Š [WIDGET] Risultati completi:`, results);
                
                if (results.length === 0) {
                    console.log(`âš ï¸ [WIDGET] Nessun risultato trovato per "${term}" in ${language}`);
                    
                    // Mostra messaggio "Nessun risultato"
                    state.searchResults = [{
                        id: 'no-results',
                        title: 'ğŸ” Nessun risultato',
                        description: `Non sono stati trovati risultati per "${term}" in ${language}. Prova con termini diversi.`,
                        type: type,
                        language: language,
                        slug_permalink: '',
                        external_url: '#'
                    }];
                } else {
                    state.searchResults = results;
                    console.log(`ğŸ¯ [WIDGET] Primo risultato: ${results[0].title} - ${results[0].external_url}`);
                    
                    // Se avevamo un contenuto selezionato, troviamo la sua versione nella nuova lingua
                    if (state.selectedContent) {
                        const newContent = results.find(r => r.id === state.selectedContent.id);
                        if (newContent) {
                            console.log(`ğŸ”„ [WIDGET] Aggiornando contenuto selezionato nella nuova lingua: ${newContent.title} - ${newContent.external_url}`);
                            console.log(`ğŸ” [WIDGET] Nuovo content seo_title:`, newContent.seo_title);
                            console.log(`ğŸ” [WIDGET] Nuovo content completo:`, newContent);
                            state.selectedContent = newContent;
                        } else {
                            console.log(`âš ï¸ [WIDGET] Non trovato content con ID ${state.selectedContent.id} nella nuova lingua`);
                        }
                    }
                }
                
                renderResults();
                updateWidget();
                
            } catch (error) {
                console.error('âŒ [WIDGET] Errore completo ricerca database:', error);
                console.error('ğŸ“‹ [WIDGET] Stack trace:', error.stack);
                
                // Fallback con messaggio di errore dettagliato
                state.searchResults = [{
                    id: 'error',
                    title: 'âš ï¸ Errore di ricerca',
                    description: `Errore: ${error.message}. Controlla la console per dettagli.`,
                    type: type,
                    language: language,
                    slug_permalink: '',
                    external_url: '#'
                }];
                
                renderResults();
                updateWidget();
            }
        }

        // UI Rendering Functions
        function renderWidget(content = null) {
            const currentLanguage = languages.find(lang => lang.code === state.selectedLanguage);
            const widgetSize = getWidgetSize(state.widgetType);
            const contentSize = getContentSize(state.widgetType);
            const titleSize = getTitleSize(state.widgetType);
            const dropdownSize = getDropdownSize(state.widgetType);
            const buttonSize = getButtonSize(state.widgetType);
            
            const title = content ? content.title : `${state.contentType.charAt(0).toUpperCase() + state.contentType.slice(1)}`;
            const description = content ? content.description : 'Eccellenza italiana di qualitÃ  premium.';
            const padding = state.widgetType === 'small' ? 'p-3' : state.widgetType === 'medium' ? 'p-4' : 'p-6';
            
            return `
                <div class="${widgetSize} bg-gradient-to-br from-gray-50 to-white rounded-3xl shadow-lg border border-gray-200 ${padding} mx-auto relative overflow-visible ${state.widgetType === 'full' ? 'flex flex-col' : ''}">
                    ${state.widgetType === 'full' ? `
                        <!-- Language Selector - Top Right nel Full -->
                        <div class="absolute top-4 right-4">
                            <div class="relative w-60">
                                <button data-dropdown-toggle 
                                        class="w-full bg-white border-2 border-cyan-300 rounded-2xl ${getButtonSize('medium')} flex items-center justify-between hover:border-cyan-400 transition-colors">
                                    <div class="flex items-center gap-2">
                                        <span class="text-base">${currentLanguage?.flag}</span>
                                        <span class="font-medium text-gray-800 text-sm truncate">${currentLanguage?.nativeName}</span>
                                    </div>
                                    <svg class="w-4 h-4 text-gray-600 transition-transform ${state.isDropdownOpen ? 'rotate-180' : ''}" 
                                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>

                                <!-- Dropdown -->
                                ${state.isDropdownOpen ? `
                                    <div class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-2xl shadow-xl z-50 ${getDropdownSize('medium')} overflow-y-auto">
                                        ${languages.map(lang => `
                                            <button data-lang-select="${lang.code}" 
                                                    class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 text-left transition-colors text-sm">
                                                <span class="text-sm">${lang.flag}</span>
                                                <span class="font-medium text-gray-800 truncate">${lang.nativeName}</span>
                                                <span class="text-xs text-gray-500 ml-auto">${lang.name}</span>
                                            </button>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Content Centrato -->
                        <div class="flex-1 flex flex-col justify-center">
                    ` : ''}
                    
                    <!-- Header -->
                    <div class="flex items-center justify-center ${state.widgetType === 'small' ? 'mb-2' : 'mb-4'}">
                        <div class="text-center">
                            <div class="font-bold text-blue-900 mb-1">
                                <span class="font-script text-blue-800">the</span>
                                <span class="ml-1 font-bold">Best</span>
                                <span class="text-red-600 ml-1">ğŸ‡®ğŸ‡¹</span>
                            </div>
                            <div class="flex items-center justify-center">
                                <div class="w-6 h-0.5 bg-green-500 mr-1"></div>
                                <span class="text-xs font-semibold text-gray-700 tracking-wider">I T A L Y</span>
                                <div class="w-6 h-0.5 bg-red-500 ml-1"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="text-center ${state.widgetType === 'small' ? 'mb-2' : state.widgetType === 'full' ? 'mb-8' : 'mb-4'}">
                        <h2 class="${titleSize} font-light text-gray-800 mb-1">${title}</h2>
                        ${state.widgetType === 'small' ? '' : `
                            <p class="${contentSize} text-gray-600 font-light">${content && content.seo_summary ? content.seo_summary : (content && content.description ? content.description.substring(0, 100) + '...' : description)}</p>
                        `}
                        ${state.widgetType === 'full' && content ? `
                            <div class="mt-4 p-4 bg-gray-50 rounded-2xl text-left" id="fullDescription">
                                <div class="text-gray-700 leading-relaxed">
                                    <div class="animate-pulse">Caricamento descrizione completa...</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    ${state.widgetType === 'full' ? `
                        <!-- View Content Button - Centrato nel Full -->
                        <div class="text-center mt-6">
                            <button data-view-content="${content ? content.id : 'null'}" 
                                    class="bg-cyan-300 hover:bg-cyan-400 rounded-2xl px-8 py-4 text-lg font-medium text-gray-800 transition-colors">
                                Visualizza ${content ? content.title : 'Contenuto'}
                            </button>
                        </div>
                        </div> <!-- Chiudi content centrato -->
                    ` : `
                        <!-- Language Selector and Action - Small/Medium -->
                        <div class="flex items-center gap-2">
                            <div class="relative flex-1">
                                <button data-dropdown-toggle 
                                        class="w-full bg-white border-2 border-cyan-300 rounded-2xl ${buttonSize} flex items-center justify-between hover:border-cyan-400 transition-colors">
                                    <div class="flex items-center gap-2">
                                        <span class="${state.widgetType === 'small' ? 'text-sm' : 'text-base'}">${currentLanguage?.flag}</span>
                                        <span class="font-medium text-gray-800 ${contentSize} truncate">${state.widgetType === 'small' ? currentLanguage?.code.toUpperCase() : currentLanguage?.nativeName}</span>
                                    </div>
                                    <svg class="w-4 h-4 text-gray-600 transition-transform ${state.isDropdownOpen ? 'rotate-180' : ''}" 
                                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>

                                <!-- Dropdown -->
                                ${state.isDropdownOpen ? `
                                    <div class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-2xl shadow-xl z-50 ${dropdownSize} overflow-y-auto">
                                        ${languages.map(lang => `
                                            <button data-lang-select="${lang.code}" 
                                                    class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 text-left transition-colors ${dropdownSize.includes('text-xs') ? 'text-xs' : dropdownSize.includes('text-sm') ? 'text-sm' : 'text-base'}">
                                                <span class="text-sm">${lang.flag}</span>
                                                <span class="font-medium text-gray-800 truncate">${lang.nativeName}</span>
                                                ${state.widgetType !== 'small' ? `<span class="text-xs text-gray-500 ml-auto">${lang.name}</span>` : ''}
                                            </button>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>

                            <button data-view-content="${content ? content.id : 'null'}" 
                                    class="bg-cyan-300 hover:bg-cyan-400 rounded-2xl ${state.widgetType === 'small' ? 'p-2' : 'p-3'} transition-colors flex-shrink-0">
                                <svg class="${state.widgetType === 'small' ? 'w-4 h-4' : 'w-5 h-5'} text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5-5 5M6 12l5 5-5 5"></path>
                                </svg>
                            </button>
                        </div>
                    `}
                </div>
            `;
        }

        function showLoadingSkeleton() {
            const widgetContainer = document.getElementById('widgetContainer');
            const widgetSize = getWidgetSize(state.widgetType);
            const padding = state.widgetType === 'small' ? 'p-3' : state.widgetType === 'medium' ? 'p-4' : 'p-6';
            
            widgetContainer.innerHTML = `
                <div class="${widgetSize} bg-white rounded-3xl shadow-lg border border-gray-200 ${padding} mx-auto">
                    <div class="animate-pulse">
                        <div class="h-3 bg-gray-200 rounded mb-3"></div>
                        <div class="h-6 bg-gray-200 rounded mb-3"></div>
                        <div class="h-3 bg-gray-200 rounded mb-3"></div>
                        <div class="h-8 bg-gray-200 rounded"></div>
                    </div>
                </div>
            `;
        }

        function renderResults() {
            const resultsList = document.getElementById('resultsList');
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (state.searchResults.length === 0) {
                resultsList.classList.add('hidden');
                return;
            }
            
            resultsList.classList.remove('hidden');
            
            resultsContainer.innerHTML = state.searchResults.map(result => {
                const typeIcon = result.type === 'azienda' ? 'ğŸ¢' : 
                               result.type === 'destinazione' ? 'ğŸ›ï¸' : 
                               'ğŸ“°';
                const typeColor = result.type === 'azienda' ? 'blue' : 
                                result.type === 'destinazione' ? 'purple' : 
                                'green';
                
                return `
                    <div class="bg-white rounded-xl shadow-md p-4 hover:shadow-xl hover:scale-105 transition-all duration-200 cursor-pointer border border-gray-100 group" 
                         onclick="selectContent(${result.id})">
                        <div class="flex items-start justify-between mb-3">
                            <div class="bg-${typeColor}-100 text-${typeColor}-600 px-2 py-1 rounded-full text-xs font-medium flex items-center gap-1">
                                ${typeIcon} ${result.type.charAt(0).toUpperCase() + result.type.slice(1)}
                            </div>
                            <svg class="w-4 h-4 text-gray-400 group-hover:text-${typeColor}-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                        <h4 class="font-semibold text-gray-800 group-hover:text-${typeColor}-600 transition-colors line-clamp-2 mb-2">${result.title}</h4>
                        <p class="text-xs text-gray-500 bg-gray-50 px-2 py-1 rounded truncate">
                            ${result.external_url.replace('https://thebestitaly.eu', '')}
                        </p>
                    </div>
                `;
            }).join('');
        }

        function updateWidget() {
            const widgetContainer = document.getElementById('widgetContainer');
            widgetContainer.innerHTML = renderWidget(state.selectedContent);
            
            // Riattacca gli event listeners dopo aver aggiornato l'HTML
            attachWidgetEventListeners();
            
            // Se Ã¨ modalitÃ  full, carica la descrizione separatamente
            if (state.widgetType === 'full' && state.selectedContent) {
                loadFullDescription(state.selectedContent);
            }
        }

        function attachWidgetEventListeners() {
            // Language dropdown toggle
            const dropdownBtn = document.querySelector('#widgetContainer button[data-dropdown-toggle]');
            if (dropdownBtn) {
                dropdownBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleDropdown();
                });
            }
            
            // Language selection buttons
            const langButtons = document.querySelectorAll('#widgetContainer [data-lang-select]');
            langButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    selectLanguage(btn.dataset.langSelect);
                });
            });
            
            // View content button
            const viewBtn = document.querySelector('#widgetContainer [data-view-content]');
            if (viewBtn) {
                viewBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    viewContent(viewBtn.dataset.viewContent);
                });
            }
        }

        // Event Handlers
        function toggleDropdown() {
            console.log('Toggle dropdown:', state.isDropdownOpen ? 'close' : 'open');
            state.isDropdownOpen = !state.isDropdownOpen;
            updateWidget();
        }

        function selectLanguage(langCode) {
            console.log('Selected language:', langCode);
            const oldLanguage = state.selectedLanguage;
            state.selectedLanguage = langCode;
            state.isDropdownOpen = false;
            
            // Se c'Ã¨ un contenuto selezionato e la lingua Ã¨ cambiata, rifai la ricerca
            if (state.selectedContent && oldLanguage !== langCode && state.searchTerm) {
                console.log(`ğŸ”„ Lingua cambiata da ${oldLanguage} a ${langCode}, rifaccio la ricerca per "${state.searchTerm}"`);
                console.log(`ğŸ” Content prima del cambio lingua:`, state.selectedContent);
                searchContent(state.contentType, state.searchTerm, langCode);
            } else {
                updateWidget();
            }
        }

        function selectContent(id) {
            const content = state.searchResults.find(r => r.id === id);
            if (content) {
                console.log('Selected content:', content.title, 'URL:', content.external_url);
                state.selectedContent = content;
                updateWidget();
            }
        }

        // Carica la descrizione completa solo per modalitÃ  full
        async function loadFullDescription(content) {
            const descriptionContainer = document.getElementById('fullDescription');
            if (!descriptionContainer || !content) return;
            
            try {
                console.log('ğŸ“– Loading full description for:', content.title);
                
                const response = await fetch('/api/widget/description', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: content.type,
                        id: content.id,
                        language: state.selectedLanguage
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const descriptionDiv = descriptionContainer.querySelector('.text-gray-700');
                    if (descriptionDiv && data.description) {
                        descriptionDiv.innerHTML = renderMarkdown(data.description);
                        console.log('âœ… Full description loaded successfully');
                    } else {
                        descriptionDiv.innerHTML = 'Descrizione non disponibile.';
                    }
                } else {
                    console.error('âŒ Failed to load description:', response.status);
                    const descriptionDiv = descriptionContainer.querySelector('.text-gray-700');
                    if (descriptionDiv) {
                        descriptionDiv.innerHTML = 'Errore nel caricamento della descrizione.';
                    }
                }
            } catch (error) {
                console.error('âŒ Error loading full description:', error);
                const descriptionDiv = descriptionContainer.querySelector('.text-gray-700');
                if (descriptionDiv) {
                    descriptionDiv.innerHTML = 'Errore nel caricamento della descrizione.';
                }
            }
        }

        function viewContent(id) {
            if (id && id !== 'null' && state.selectedContent) {
                const url = state.selectedContent.external_url;
                console.log(`ğŸ”— Aprendo contenuto: ${state.selectedContent.title} â†’ ${url}`);
                
                if (url && url !== '#') {
                    // Apri il contenuto nell'URL esterno
                    window.open(url, '_blank');
                } else {
                    alert(`Contenuto selezionato: ${state.selectedContent.title}\nURL non disponibile`);
                }
            } else {
                alert('Seleziona prima un contenuto dalla ricerca');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log(`ğŸŒ Widget caricato con ${languages.length} lingue supportate (esattamente 50)!`);
            console.log('ğŸ” Prova a cercare: "Ferrari", "Roma", "Venezia", "Prada"');
            
            // Event listeners
            document.getElementById('widgetType').addEventListener('change', function(e) {
                state.widgetType = e.target.value;
                state.isDropdownOpen = false; // Chiudi dropdown quando cambi tipo
                updateWidget();
            });

            document.getElementById('contentType').addEventListener('change', function(e) {
                state.contentType = e.target.value;
                state.selectedContent = null;
                state.isDropdownOpen = false; // Chiudi dropdown
                updateWidget();
            });

            document.getElementById('searchBtn').addEventListener('click', function() {
                const term = document.getElementById('searchTerm').value.trim();
                if (!term) {
                    alert('Inserisci un termine di ricerca');
                    return;
                }
                state.searchTerm = term;
                state.isDropdownOpen = false; // Chiudi dropdown durante ricerca
                searchContent(state.contentType, term, state.selectedLanguage);
            });

            document.getElementById('searchTerm').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('searchBtn').click();
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#widgetContainer') && state.isDropdownOpen) {
                    state.isDropdownOpen = false;
                    updateWidget();
                }
            });

            // Initial render
            updateWidget();
        });
    </script>

    <!-- Implementation Section -->
    <div class="max-w-6xl mx-auto px-4 py-16 bg-white">
        <h2 class="text-3xl font-bold text-center mb-12 text-gray-800">ğŸ’» Guida all'Implementazione</h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- HTML Integration -->
            <div class="bg-gray-900 rounded-xl p-6 text-white">
                <h3 class="text-xl font-semibold mb-4 text-cyan-300">ğŸ”§ Integrazione HTML</h3>
                <p class="text-gray-300 mb-4">Copia e incolla nel tuo sito:</p>
                <div class="bg-black rounded-lg p-4 overflow-x-auto">
                    <pre class="text-green-400 text-sm"><code>&lt;!-- Widget theBest Italy --&gt;
&lt;div id="thebestitaly-widget"&gt;&lt;/div&gt;
&lt;script&gt;
(function() {
    var script = document.createElement('script');
    script.src = 'https://thebestitaly.eu/widgets/widget.js';
    script.async = true;
    script.onload = function() {
        TheBestItaly.init({
            container: '#thebestitaly-widget',
            type: 'azienda', // articolo | destinazione | azienda
            size: 'medium',  // small | medium | full
            language: 'it'   // auto-detect o codice lingua
        });
    };
    document.head.appendChild(script);
})();
&lt;/script&gt;</code></pre>
                </div>
            </div>

            <!-- API Structure -->
            <div class="bg-blue-50 rounded-xl p-6">
                <h3 class="text-xl font-semibold mb-4 text-blue-800">ğŸ”— Struttura URL</h3>
                <div class="space-y-4">
                    <div class="bg-white rounded-lg p-4 border-l-4 border-blue-500">
                        <h4 class="font-semibold text-blue-800 mb-2">ğŸ¢ Aziende</h4>
                        <code class="text-sm text-blue-600">/{lingua}/poi/{slug}</code>
                        <p class="text-xs text-blue-600 mt-1">es: /it/poi/ferrari-spa</p>
                </div>

                    <div class="bg-white rounded-lg p-4 border-l-4 border-green-500">
                        <h4 class="font-semibold text-green-800 mb-2">ğŸ“° Articoli</h4>
                        <code class="text-sm text-green-600">/{lingua}/magazine/{slug}</code>
                        <p class="text-xs text-green-600 mt-1">es: /it/magazine/cucina-italiana</p>
                </div>

                    <div class="bg-white rounded-lg p-4 border-l-4 border-purple-500">
                        <h4 class="font-semibold text-purple-800 mb-2">ğŸ›ï¸ Destinazioni</h4>
                        <code class="text-sm text-purple-600">/{lingua}/{regione}/{provincia}/{municipalitÃ }</code>
                        <p class="text-xs text-purple-600 mt-1">es: /it/lombardia/milano/milano</p>
                    </div>
                </div>
            </div>

            <!-- React Integration -->
            <div class="bg-gray-900 rounded-xl p-6 text-white">
                <h3 class="text-xl font-semibold mb-4 text-cyan-300">âš›ï¸ React/Next.js</h3>
                <div class="bg-black rounded-lg p-4 overflow-x-auto">
                    <pre class="text-blue-400 text-sm"><code>import { useEffect } from 'react';

function TheBestItalyWidget() {
    useEffect(() => {
        const script = document.createElement('script');
        script.src = 'https://thebestitaly.eu/widgets/widget.js';
        script.async = true;
        
        script.onload = () => {
            window.TheBestItaly.init({
                container: '#widget-container',
                type: 'azienda',
                size: 'medium',
                language: 'it'
            });
        };
        
        document.head.appendChild(script);
        
        return () => {
            document.head.removeChild(script);
        };
    }, []);

    return &lt;div id="widget-container"&gt;&lt;/div&gt;;
}</code></pre>
                </div>
            </div>

            <!-- API Direct -->
            <div class="bg-purple-50 rounded-xl p-6">
                <h3 class="text-xl font-semibold mb-4 text-purple-800">ğŸ› ï¸ API Diretta</h3>
                <p class="text-purple-700 mb-4">Endpoint per integrazioni personalizzate:</p>
                <div class="bg-white rounded-lg p-4 border border-purple-200">
                    <pre class="text-purple-600 text-sm"><code>POST /api/widget/search

{
  "type": "azienda",
  "query": "Ferrari", 
  "language": "it",
  "limit": 5
}</code></pre>
                </div>
                <div class="mt-4 p-3 bg-purple-100 rounded-lg">
                    <p class="text-xs text-purple-700">
                        <strong>âœ¨ Caratteristiche:</strong> Cache 5min, slug_permalink, URL esterni, 40+ lingue
                    </p>
                </div>
            </div>
                </div>
                
        <!-- Features Grid -->
        <div class="mt-16">
            <h3 class="text-2xl font-bold text-center mb-8 text-gray-800">ğŸš€ Caratteristiche Premium</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center p-6 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl">
                    <div class="text-4xl mb-4">ğŸŒ</div>
                    <h4 class="font-semibold text-gray-800 mb-2">Multilingua</h4>
                    <p class="text-sm text-gray-600">Supporto completo per 50 lingue con traduzione automatica</p>
                </div>
                
                <div class="text-center p-6 bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl">
                    <div class="text-4xl mb-4">âš¡</div>
                    <h4 class="font-semibold text-gray-800 mb-2">Performance</h4>
                    <p class="text-sm text-gray-600">Cache intelligente, caricamento asincrono, ottimizzato per mobile</p>
                </div>
                
                <div class="text-center p-6 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl">
                    <div class="text-4xl mb-4">ğŸ¯</div>
                    <h4 class="font-semibold text-gray-800 mb-2">SEO Boost</h4>
                    <p class="text-sm text-gray-600">Backlink di qualitÃ  da thebestitaly.eu per migliorare il ranking</p>
                </div>
            </div>
        </div>

        <!-- CTA -->
        <div class="mt-16 text-center">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-2xl p-8">
                <h3 class="text-2xl font-bold mb-4">Pronto per iniziare?</h3>
                <p class="text-lg opacity-90 mb-6">Integra il widget in meno di 2 minuti</p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="/widgets/widget.js" target="_blank" 
                       class="bg-white text-blue-600 px-6 py-3 rounded-lg font-semibold hover:bg-blue-50 transition-colors">
                        ğŸ“¥ Scarica Widget.js
                    </a>
                    <a href="/widgets/integration.md" target="_blank"
                       class="bg-blue-500 hover:bg-blue-400 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                        ğŸ“– Guida Completa
                    </a>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 